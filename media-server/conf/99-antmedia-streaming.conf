# ============================================================================
# StreamLick Ant Media Server - Linux Kernel Network Tuning
# Maximum Stability Settings for High-Performance Streaming
# ============================================================================
# Location: /etc/sysctl.d/99-antmedia-streaming.conf
# Apply with: sudo sysctl -p /etc/sysctl.d/99-antmedia-streaming.conf
# ============================================================================

# ------------- NETWORK BUFFER TUNING -------------
# Increases buffer sizes for high-bandwidth streaming
# Critical for RTMP push consistency and WebRTC low-latency delivery

# Maximum receive socket buffer size (bytes)
net.core.rmem_max = 2500000

# Maximum send socket buffer size (bytes)
net.core.wmem_max = 2500000

# Default receive buffer size
net.core.rmem_default = 1000000

# Default send buffer size
net.core.wmem_default = 1000000

# TCP receive buffer sizes (min, default, max)
net.ipv4.tcp_rmem = 4096 87380 2500000

# TCP send buffer sizes (min, default, max)
net.ipv4.tcp_wmem = 4096 65536 2500000

# ------------- TCP STACK OPTIMIZATION -------------
# Improves connection handling under high load

# Maximum SYN backlog (pending connections queue)
net.ipv4.tcp_max_syn_backlog = 8192

# Reduce TIME_WAIT socket timeout
net.ipv4.tcp_fin_timeout = 15

# Allow TIME_WAIT socket reuse
net.ipv4.tcp_tw_reuse = 1

# Enable TCP Fast Open
net.ipv4.tcp_fastopen = 3

# ------------- UDP OPTIMIZATION -------------
# Critical for WebRTC media streams

# UDP receive buffer
net.core.netdev_max_backlog = 50000

# ------------- CONNECTION TRACKING -------------
# For handling many simultaneous streams

# Maximum tracked connections
net.netfilter.nf_conntrack_max = 1048576

# Connection tracking timeout for UDP (seconds)
# Helps with WebRTC NAT traversal
net.netfilter.nf_conntrack_udp_timeout = 60
net.netfilter.nf_conntrack_udp_timeout_stream = 180

# ------------- MEMORY SETTINGS -------------
# Virtual memory tuning for streaming workloads

# Reduce swappiness (prefer RAM over swap)
vm.swappiness = 10

# Increase inotify watches for file monitoring
fs.inotify.max_user_watches = 524288

# ------------- FILE DESCRIPTOR LIMITS -------------
# Support many concurrent connections

fs.file-max = 2097152

# ============================================================================
# After applying, also update /etc/security/limits.conf:
#
# antmedia soft nofile 65535
# antmedia hard nofile 65535
# antmedia soft nproc 65535
# antmedia hard nproc 65535
# ============================================================================
